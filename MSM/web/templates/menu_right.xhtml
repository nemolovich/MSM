<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:c="http://java.sun.com/jsp/jstl/core">
    <h:head>
    </h:head>
    <h:body>
        <f:view>
            <h:form id="friendsMenuDataForm">
                <script type="text/javascript">
                    var eventData;
                    function handleMessage(event) {
                        console.log('Message: '+event);
                    }
                    function displayEvent(xhr,status,args){
                        eventData=args;
                        console.log(args);
                    }
                    function useCommandButton(buttonId)
                    {
                        $('#'+buttonId).click();
                    }
                </script>
                <p:commandButton id="useQueue"
                                 action="#{userLogin.useQueue()}"
                                 update=":growl"
                                 style="display:none;"/>
                <p:commandButton id="myChatButton"
                                 actionListener="#{userLogin.getMessage()}"
                                 update=":growl
                                 :friendsMenuDataForm:friendChat"
                                 style="display:none;"/>
                <p:socket channel="/chat#{userLogin.user.id}" onError="handleMessage"
                          onMessage="handleMessage">
                    <p:ajax event="message"
                            process="@this"
                            update=":growl
                                 :friendsMenuDataForm:friendChat"
                            onstart="if(!chatDisplay){showChat();}"/>
                </p:socket>
                <!--useCommandButton('friendsMenuDataForm\\\\:useQueue');}-->
                <p:accordionPanel multiple="true">
                    <p:tab id="onlineFriendsTab"
                           title="Online friends">
                        <p:contextMenu id="friendsContextMenu"
                                       style="width:200px;margin:auto;padding:auto;"
                                       for="friendsMenuDataTable">
                            <p:menuitem value="Send message"
                                        title="Send message to your friend"
                                        onstart="showChat();"
                                        update=":friendsMenuDataForm:friendChat"
                                        icon="ui-icon-comment"
                                        immediate="true"
                                        actionListener="#{userLogin.chat.createConversation(usersView.entity)}"/>
                        </p:contextMenu>
                        <p:contextMenu id="friendsOfflineContextMenu"
                                       style="width:200px;margin:auto;padding:auto;"
                                       for="friendsMenuRevertDataTable">
                            <p:menuitem value="Send message"
                                        title="Send message to your friend"
                                        onstart="showChat();"
                                        update=":friendsMenuDataForm:friendChat"
                                        icon="ui-icon-comment"
                                        immediate="true"
                                        actionListener="#{userLogin.chat.createConversation(usersView.entity)}"/>
                        </p:contextMenu>
                        <p:dataTable id="friendsMenuDataTable"
                                     value="#{usersMultiView.getData(
                                              friendsRelationView.getFriendsFor(
                                              userLogin.user))}"
                                     var="user"
                                     widgetVar="friendsMenuTable"
                                     rowIndexVar="index"
                                     emptyMessage="No friend has been found"
                                     paginator="false"
                                     sortBy="#{user.firstname}"
                                     paginatorPosition="bottom"
                                     filteredValue="#{usersMultiView.filteredEntities}"
                                     selection="#{usersView.entity}"
                                     selectionMode="single">
                            <p:ajax event="contextMenu"
                                    process="@this"/>

                            <p:column id="friendFilter"
                                      headerText=""
                                      filterBy="#{user.firstname} or #{user.name}"
                                      filterMatchMode="contains"
                                      filterPosition="bottom"
                                      filterStyle="display:none;">
                                <f:facet name="header">
                                    <p:outputPanel style="float:left;">
                                        <h:outputText value="Search:"/>
                                        <p:inputText id="globalFilter"
                                                     onkeyup="doAfterInterval('forceFilter(friendsMenuTable);',1);"
                                                     style="width:150px;margin-left:20px;"
                                                     title="Search a friend">
                                        </p:inputText>
                                    </p:outputPanel>
                                </f:facet>
                                <div class="green_icon"
                                      style="display:inline-block;vertical-align:bottom;">
                                    <span class="ui-icon ui-corner-all ui-icon-circle-arrow-e"/>
                                </div>
                                <h:outputText value="#{user.firstname} #{user.name}"
                                              style="display:inline-block;margin-left:10px;"/>
                            </p:column>

                        </p:dataTable>
                        <script type="text/javascript">
                            $(document).ready(function(){
                                friendsMenuTable.filter();
                            });
                        </script>
                    </p:tab>
                    <p:tab id="offlineFriendsTab"
                           title="Offline friends">
                        <p:dataTable id="friendsMenuRevertDataTable"
                                     value="#{usersMultiView.getData(
                                              friendsRelationView.getFriendsFor(
                                              userLogin.user))}"
                                     var="offUser"
                                     widgetVar="friendsMenuTableRevert"
                                     rowIndexVar="index"
                                     emptyMessage="No friend has been found"
                                     paginator="false"
                                     styleClass="table_headers_hidden"
                                     sortBy="#{user.firstname}"
                                     paginatorPosition="bottom"
                                     filteredValue="#{usersMultiView.revertFilteredEntities}"
                                     selection="#{usersView.entity}"
                                     selectionMode="single">
                            <p:ajax event="contextMenu"
                                    process="@this"/>

                            <p:column>
                                <div class="red_icon"
                                      style="display:inline-block;vertical-align:bottom;">
                                    <span class="ui-icon ui-corner-all ui-icon-circle-close"/>
                                </div>
                                <h:outputText value="#{offUser.firstname} #{offUser.name}"
                                              style="display:inline-block;margin-left:10px;
                                              font-style:italic;"/>
                            </p:column>

                        </p:dataTable>
                        <script type="text/javascript">
                            $(document).ready(function(){
                                friendsMenuTableRevert.filter();
                            });
                        </script>
                    </p:tab>
                </p:accordionPanel>
                
                <p:outputPanel id="friendChat"
                               styleClass="chatPanel">
                    <script type="text/javascript">
                        $(document).ready(function()
                        {
                            $('#friendsMenuDataForm\\:chatHeader').click(function()
                            {
                                showChat()
                            });
                            addTitle('friendsMenuDataForm\\:chatHeader', 'Display conversations');
                            if(#{not userLogin.chat.chatOpened})
                            {
                                hideChat();
                            }
                            else
                            {
                                chatDisplay=true;
                            }
                    });
                    </script>
                    <p:outputPanel styleClass="chatContainer">
                        <p:commandLink id="chatHeader"
                                       actionListener="#{userLogin.chat.switchOpenState()}"
                                       styleClass="chatHeader"
                                       value="#{userLogin.chat.nbConversations} conversations">
                        </p:commandLink>
                        <p:commandButton id="chatCloser"
                                         icon="ui-icon-closethick"
                                         styleClass="red_icon"
                                         title="Hide conversations"
                                         actionListener="#{userLogin.chat.setChatOpened(false)}"
                                         onclick="hideChat();"/>
                    </p:outputPanel>
                    <p:outputPanel id="friendsChatText"
                                   rendered="#{not userLogin.chat.noConversation}"
                                   style="display:block;">
                        <div id="friendsChatText"
                             class="ui-tabs ui-widget ui-widget-content ui-corner-all ui-hidden-container ui-tabs-bottom tabview_scrollable">
                            <div id="chat_tabView"
                                 class="ui-tabs-panels">
                                <div id="chatTab_default"
                                     class="chatContent">
                                    <h:outputText value="You don't have opened conversations"/>
                                    <script type="text/javascript">
                                        if(#{userLogin.chat.currentIndex}>0)
                                        {
                                            $('#chatTab_default').css('display','none');
                                        }
                                    </script>
                                </div>
                                <c:forEach items="#{userLogin.chat.conversations}"
                                           var="convers">
                                    <div id="chatTab_#{convers.id}"
                                         class="chatContent"
                                         style="display:none;">
                                        <c:forEach items="#{userLogin.chat.getLastConversWith(convers)}"
                                                   var="message">
                                            <h:outputText value="#{utils.getBreakLinesString(message.message)}"
                                                          styleClass="chatMessage #{message.sent?'sendingMessage':'receivedMessage'}"
                                                          escape="false"/>
                                        </c:forEach>
                                    </div>
                                </c:forEach>
                                <div class="messageSender">
                                    <p:inputTextarea rows="1"
                                                     value="#{userLogin.chat.currentMessage}"
                                                     autoResize="false"
                                                     maxlength="500"
                                                     styleClass="sendMessage"
                                                     title="Type your message">
                                    </p:inputTextarea>
                                    <p:commandButton value="Send"
                                                     title="Send your message"
                                                     icon="ui-icon-comment"
                                                     onstart="displayAjaxStatus=false;"
                                                     oncomplete="displayAjaxStatus=false;"
                                                     styleClass="sendButton"
                                                     update=":friendsMenuDataForm:friendChat
                                                     :growl"
                                                     actionListener="#{userLogin.chat.addMessage()}"/>
                                </div>
                                <ul class="ui-tabs-nav ui-helper-reset ui-helper-clearfix ui-widget-header ui-corner-all"
                                    role="tablist">
                                    <c:forEach id="chat_tabView_selector"
                                               items="#{userLogin.chat.conversations}"
                                               var="convers">
                                        <li id="chatLi_#{convers.id}"
                                            class="ui-state-default"
                                            title="Display conversation with #{convers.firstname}"
                                            role="tab"
                                            aria-expanded="false"
                                            onclick="displayChatTab('chat_tabView',#{convers.id},#{userLogin.chat.getIndexOf(convers)},this);">
                                            <h:outputText value="#{utils.getShortString(
                                                                   (convers.firstname!=null?
                                                                   (convers.firstname.concat(' ').concat(convers.name)):
                                                                   'friend'),15)}"/>
                                            <p:commandButton id="chatTab_button_#{convers.id}"
                                                             style="visibility: hidden;"
                                                             actionListener="#{userLogin.chat.switchUser(convers)}"/>
                                            <script type="text/javascript">
                                                verifChatTabIndex('chat_tabView',#{userLogin.chat.currentIndex},#{convers.id},#{userLogin.chat.getIndexOf(convers)});
                                            </script>
                                        </li>
                                    </c:forEach>
                                </ul>
                            </div>
                        </div>
                    
                        <script type="text/javascript" id="setScrollTabScript">
                            $(document).ready(function()
                            {
                                setChatTabScrollable(#{userLogin.chat.nbConversations});
                            });
                        </script>
                    </p:outputPanel>
                    <p:outputPanel id="friendsChatText0"
                                   rendered="#{userLogin.chat.noConversation}">
                        <center class="chatContent">
                            0 conversations
                        </center>
                    </p:outputPanel>
                </p:outputPanel>
                
            </h:form>
        </f:view>
    </h:body>
</html>

